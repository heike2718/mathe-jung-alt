<div class="mja-container" *ngIf="raetselFacade.editRaetselPayload$ | async as guiEditRaetselPayload else keinRaetsel">
    <mat-card>
        <mat-card-header>
            <mat-card-title>Rätseleditor</mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="form" novalidate>
                <div class="mja-form">

                    <!-- SCHLUESSEL -->
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Schlüssel</mat-label>
                            <input matInput maxlength="5" inputmode="tel" formControlName="schluessel" #schluesselInput>
                            <mat-hint *ngIf="isRoot">für neue Rätsel beim Speichern generieren</mat-hint>
                            <mat-hint *ngIf="!isRoot">wird vom System generiert</mat-hint>
                            <mat-error *ngIf="raetselDataError('schluessel', 'required')">Schlüssel ist
                                Pflicht</mat-error>
                            <mat-error *ngIf="raetselDataError('schluessel', 'pattern')">genau 5 Ziffern - nach
                                links
                                mit 0
                                auffüllen
                            </mat-error>
                        </mat-form-field>
                    </div>

                    <!-- Name -->
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Name</mat-label>
                            <input matInput maxlength="100" formControlName="name" #nameInput>
                            <mat-hint>wird in der Tabelle angezeigt</mat-hint>
                            <mat-hint align="end">{{nameInput.value.length}}/100</mat-hint>
                            <mat-error *ngIf="raetselDataError('name', 'required')">Name ist Pflicht</mat-error>
                            <mat-error *ngIf="raetselDataError('name', 'maxLength')">maximal 100 Zeichen</mat-error>
                        </mat-form-field>
                    </div>

                    <!-- Kommentar -->
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Kommentar</mat-label>
                            <input matInput maxlength="200" formControlName="kommentar" #kommentarInput>
                            <mat-hint>Kommentare sind in Volltextsuche eingebunden</mat-hint>
                            <mat-hint align="end">{{kommentarInput.value.length}}/200</mat-hint>
                            <mat-error *ngIf="raetselDataError('kommentar', 'maxLength')">maximal 200
                                Zeichen</mat-error>
                        </mat-form-field>
                    </div>

                    <!-- Herkunftstyp -->
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Herkunftstyp</mat-label>
                            <mat-hint>{{guiEditRaetselPayload.quellenangabe}}</mat-hint>
                            <mat-select matNativeControl formControlName="herkunftstyp" #herkunftstypInput
                                (selectionChange)="onSelectHerkunftstyp($event.value)">
                                <mat-option *ngFor="let herkunftstyp of selectHerkunftstypInput" [value]="herkunftstyp">
                                    {{herkunftstyp}}</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>


                    <div *ngIf="selectedHerkunftstyp !== 'EIGENKREATION'">
                        <h2>Quellenangaben</h2>

                        <p *ngIf="selectedMedium !== undefined">{{selectedMedium.titel}}</p>

                        <!-- Quellenart -->
                        <div class="mb-2">
                            <mat-form-field>
                                <mat-label>Quellenart</mat-label>
                                <mat-hint>{{guiEditRaetselPayload.editRaetselPayload.quelle.quellenart}}</mat-hint>
                                <mat-select matNativeControl formControlName="quellenart" #quellenartInput
                                    (selectionChange)="onSelectQuellenart($event.value)">
                                    <mat-option *ngFor="let quellenart of selectQuellenartInput" [value]="quellenart">
                                        {{quellenart}}</mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>                        

                        <!-- Mediensuche -->
                        <div *ngIf="showMediensuche" class="mb-2">
                            <mat-form-field>
                                <mat-label>Medien</mat-label>
                                <mat-select matNativeControl formControlName="medium" #mediumInput [compareWith]="compareMedia"
                                    (selectionChange)="onSelectMedium($event.value)">
                                    <mat-option *ngFor="let medium of medienForQuelle"
                                        [value]="medium">
                                        {{ medium.titel }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>

                        <!-- Person -->
                        <div *ngIf="showPerson" class="mb-2">
                            <mat-form-field>
                                <mat-label>Person(en)</mat-label>
                                <input matInput maxlength="100" formControlName="person" #personInput>
                                <mat-hint align="end">{{personInput.value.length}}/100</mat-hint>
                                <mat-error *ngIf="raetselDataError('person', 'maxLength')">maximal 100
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Jahr -->
                        <div *ngIf="showJahr" class="mb-2">
                            <mat-form-field>
                                <mat-label>Jahr</mat-label>
                                <input matInput maxlength="4" formControlName="jahr" #jahrInput>
                                <mat-hint align="end">{{jahrInput.value.length}}/4</mat-hint>
                                <mat-error *ngIf="raetselDataError('jahr', 'maxLength')">maximal 4
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Ausgabe -->
                        <div *ngIf="showAusgabe" class="mb-2">
                            <mat-form-field>
                                <mat-label>Ausgabe</mat-label>
                                <input matInput maxlength="10" formControlName="ausgabe" #ausgabeInput>
                                <mat-hint align="end">{{ausgabeInput.value.length}}/10</mat-hint>
                                <mat-error *ngIf="raetselDataError('ausgabe', 'maxLength')">maximal 10
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Seite -->
                        <div *ngIf="showSeite" class="mb-2">
                            <mat-form-field>
                                <mat-label>Seite</mat-label>
                                <input matInput maxlength="4" formControlName="seite" #seiteInput>
                                <mat-hint align="end">{{seiteInput.value.length}}/4</mat-hint>
                                <mat-error *ngIf="raetselDataError('seite', 'maxLength')">maximal 4
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Klasse -->
                        <div *ngIf="showKlasse" class="mb-2">
                            <mat-form-field>
                                <mat-label>Klasse</mat-label>
                                <input matInput maxlength="10" formControlName="klasse" #klasseInput>
                                <mat-hint align="end">{{klasseInput.value.length}}/10</mat-hint>
                                <mat-error *ngIf="raetselDataError('klasse', 'maxLength')">maximal 10
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Stufe -->
                        <div *ngIf="showStufe" class="mb-2">
                            <mat-form-field>
                                <mat-label>Stufe</mat-label>
                                <input matInput maxlength="10" formControlName="stufe" #stufeInput>
                                <mat-hint align="end">{{stufeInput.value.length}}/10</mat-hint>
                                <mat-error *ngIf="raetselDataError('stufe', 'maxLength')">maximal 10
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>

                        <!-- Pfad -->
                        <div *ngIf="showPfad" class="mb-2">
                            <mat-form-field>
                                <mat-label>Pfad</mat-label>
                                <input matInput maxlength="500" formControlName="pfad" #pfadInput>
                                <mat-hint align="end">{{pfadInput.value.length}}/500</mat-hint>
                                <mat-error *ngIf="raetselDataError('pfad', 'maxLength')">maximal 500
                                    Zeichen</mat-error>
                            </mat-form-field>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Status</mat-label>
                            <select matNativeControl formControlName="status" #statusInput>
                                <option *ngFor="let status of selectStatusInput" [value]="status">{{status}}
                                </option>
                            </select>
                        </mat-form-field>
                    </div>

                    <!-- Frage -->
                    <h2>Frage</h2>
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Frage</mat-label>
                            <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize"
                                [cdkAutosizeMinRows]="5" [cdkAutosizeMaxRows]="15" placeholder="Frage"
                                formControlName="frage" #frageInput></textarea>
                            <mat-hint>LaTeX-Schnipsel ohne Präambel und document-Umgebung</mat-hint>
                            <mat-error *ngIf="raetselDataError('frage', 'required')">Frage ist Pflicht</mat-error>
                        </mat-form-field>
                    </div>


                    <mat-expansion-panel (opened)="panelGrafikenFrageOpen=true"
                        (closed)="panelGrafikenFrageOpen = false">
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                Grafiken Frage (eingebundene Bilder anzeigen oder neue hochladen)
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <h2 *ngIf="embeddableImageInfosFrage.length > 0">Eingebundene Bilder</h2>
                        <mat-nav-list *ngIf="embeddableImageInfosFrage.length > 0">
                            <mat-list-item *ngFor="let embeddableImageInfo of embeddableImageInfosFrage">
                                <mja-ws-embeddable-image-info
                                    [embeddableImageInfo]="embeddableImageInfo"></mja-ws-embeddable-image-info>
                            </mat-list-item>
                        </mat-nav-list>

                        <div class="mb-2">
                            <!-- fileSelected transportiert ein FileInfoModel- Objekt -->
                            <mja-select-file [selectFileModel]="selectFileFrageModel"
                                (fileSelected)="onFileSelected($event, 'FRAGE')"></mja-select-file>

                            <mja-file-info *ngIf="fileInfoFrage" [titel]="selectFileFrageModel.titel"
                                [beschreibung]="selectFileFrageModel.beschreibung" [fileName]="fileInfoFrage.file.name"
                                [maxSizeBytes]="selectFileFrageModel.maxSizeBytes"
                                [actualFileSize]="fileInfoFrage.fileSize">
                            </mja-file-info>

                            <button mat-raised-button color="primary" *ngIf="fileInfoFrage"
                                title="gewählte Datei hochladen" (click)="uploadFile('FRAGE')">Datei hochladen</button>
                        </div>
                    </mat-expansion-panel>



                    <!-- Lösung -->
                    <h2>Lösung</h2>
                    <div class="mb-2">
                        <mat-form-field>
                            <mat-label>Lösung</mat-label>
                            <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize"
                                [cdkAutosizeMinRows]="5" [cdkAutosizeMaxRows]="15" placeholder="Lösung"
                                formControlName="loesung" #loesungInput></textarea>
                            <mat-hint>LaTeX-Schnipsel ohne Präambel und document-Umgebung</mat-hint>
                        </mat-form-field>
                    </div>

                    <mat-expansion-panel>
                        <mat-expansion-panel-header>
                            <mat-panel-title>
                                Grafiken Lösung (eingebundene Bilder anzeigen oder neue hochladen)
                            </mat-panel-title>
                        </mat-expansion-panel-header>
                        <mat-nav-list *ngIf="embeddableImageInfosLoesung.length > 0">
                            <mat-list-item *ngFor="let embeddableImageInfo of embeddableImageInfosLoesung">
                                <mja-ws-embeddable-image-info
                                    [embeddableImageInfo]="embeddableImageInfo"></mja-ws-embeddable-image-info>
                            </mat-list-item>
                        </mat-nav-list>

                        <div class="mb-2">
                            <!-- fileSelected transportiert ein FileInfoModel- Objekt -->
                            <mja-select-file *ngIf="!fileInfoLoesung" [selectFileModel]="selectFileLoesungModel"
                                (fileSelected)="onFileSelected($event, 'LOESUNG')"></mja-select-file>

                            <mja-file-info *ngIf="fileInfoLoesung" [titel]="selectFileLoesungModel.titel"
                                [beschreibung]="selectFileLoesungModel.beschreibung"
                                [fileName]="fileInfoLoesung.file.name"
                                [maxSizeBytes]="selectFileLoesungModel.maxSizeBytes"
                                [actualFileSize]="fileInfoLoesung.fileSize">
                            </mja-file-info>

                            <button mat-raised-button color="primary" *ngIf="fileInfoLoesung"
                                title="gewählte Datei hochladen" (click)="uploadFile('LOESUNG')">Datei
                                hochladen</button>
                        </div>
                    </mat-expansion-panel>

                    <div class="mb-2 mt-2">
                        <mat-form-field>
                            <mat-label>Anzahl Antwortvorschläge</mat-label>
                            <select matNativeControl formControlName="anzahlAntwortvorschlaege"
                                #anzahlAntwortvorschlaegeInput (change)="onChangeAnzahlAntwortvorschlaege($event)">
                                <option *ngFor="let anz of anzahlenAntwortvorschlaege" [value]="anz">{{anz}}
                                </option>
                            </select>
                        </mat-form-field>
                    </div>

                    <!-- Antwortvorschlag- Controls -->
                    <div *ngFor="let antwortvorschlag of antwortvorschlaegeFormGroup; let i = index">
                        <h3>Antwortvorschlag {{getBuchstabe(i)}}</h3>

                        <div [formGroup]="antwortvorschlag">
                            <div class="mb-2">
                                <mat-form-field>
                                    <mat-label>Text</mat-label>
                                    <input matInput maxlength="30" formControlName="text" #textInput>
                                    <mat-hint>Text des Antwortvorschlags - Wort oder kurze Wortgruppe</mat-hint>
                                </mat-form-field>
                            </div>

                            <div class="mb-2">
                                <mat-slide-toggle formControlName="korrekt" #korrektInput color="primary"> korrekt
                                    (nein/ja)</mat-slide-toggle>
                            </div>
                        </div>
                    </div>
                    <mat-error *ngIf="antwortvorschlaegeErrors()">Antwortvorschläge sind noch fehlerhaft: genau
                        einer
                        muss
                        korrekt sein.</mat-error>
                </div>
            </form>

            <!-- Deskriptoren -->
            <div *ngIf="selectItemsCompomentModel">
                <mja-select-items [model]="selectItemsCompomentModel"
                    (modelChanged)="onSelectItemsCompomentModelChanged($event)"></mja-select-items>
            </div>
        </mat-card-content>

        <mat-card-actions>
            <button mat-raised-button color="primary" [disabled]="!form.valid || antwortvorschlaegeErrors()"
                (click)="submit()">speichern</button>
            <button mat-raised-button color="primary" [disabled]="generierenDiabled()"
                matTooltip="PNG Frage und Lösung generieren" (click)="printPNG()">PNG
                generieren</button>
            <button *ngIf="raetselFacade.generateLatexError$ | async" mat-raised-button color="primary"
                matTooltip="LaTeX: Logdateien herunterladen" (click)="downloadLatexLogs()">LaTeX-Logs</button>
            <button *ngIf="guiEditRaetselPayload.editRaetselPayload.id !== 'neu'" mat-raised-button color="primary"
                matTooltip="zurück zur Detailansicht" (click)="cancelEdit()">Abbruch/Details</button>
            <button mat-raised-button color="primary" matTooltip="zurück zur Suche"
                (click)="gotoSuche()">Rätselsuche</button>
        </mat-card-actions>
        <mat-card-footer *ngIf="(!form.valid || antwortvorschlaegeErrors())">
            <mat-error *ngIf="(!form.valid || antwortvorschlaegeErrors())">
                Tja, das kann so noch nicht gespeichert werden. Es gibt noch Validierungsfehler, z.B. fehlende
                Pflichtangaben und so.
            </mat-error>
        </mat-card-footer>
    </mat-card>
</div>

<ng-template #keinRaetsel>
    <h1>Rätseleditor</h1>
    <p>kein Rätsel ausgewählt</p>
</ng-template>

<ng-template #keineImagesGeneriert>
    <p>noch keine Images generiert</p>
</ng-template>